#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e

build_dir=$1
cache_dir=$2
env_dir=$3
bp_dir=$(dirname $(dirname $0))

case "${STACK}" in
  cedar-14|heroku-16|heroku-18)
    # The buildpack for some time has used binaries meant for Cedar-14 on all stacks (see #165).
    # In the future these stacks should be migrated to newer nginx built against the correct stack.
    nginx_archive_url='https://heroku-buildpack-ruby.s3.amazonaws.com/nginx/cedar-14/nginx-1.9.7-ngx_mruby.tgz'
    ;;
  *)
    echo "Stack ${STACK} is not supported!"
    exit 1
    ;;
esac

mkdir -p $build_dir/bin
curl -sSf "${nginx_archive_url}" | tar -xzC "${build_dir}/bin"
nginx_version=$($build_dir/bin/nginx-$STACK -V 2>&1 | head -1 | awk '{ print $NF }')
cp -a $bp_dir/scripts/{boot,config} -t $build_dir/bin/
echo "-----> Installed ${nginx_version} to /app/bin"

mkdir -p $build_dir/config
cp $bp_dir/scripts/config/templates/mime.types $build_dir/config

echo "~~~~~> Create .htpasswd file for source maps"
touch $build_dir/config/.htpasswd
cat $env_dir/SOURCE_MAP_HTPASSWD > $build_dir/config/.htpasswd

mkdir -p $build_dir/logs
